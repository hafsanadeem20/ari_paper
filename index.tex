% !TeX root = RJwrapper.tex
\title{The Automated R Instructor}
\author{by Sean Kross, John Muschelli, Jeffrey T. Leek}

\maketitle

\abstract{%
We present the \texttt{ari} package for video generation of teaching
materials. The goal of the package is to be able to generate
reproducible videos, with the ability to change and update videos
seamlessly. We present an example of generating videos with RMarkdown
slide decks with inline comments as the spoken script along with
examples using PowerPoint slides or simple images. We also discusss how
these videos can be translated into a number of languages from multiple
input formats.
}

% Any extra LaTeX you need in the preamble

\hypertarget{introduction}{%
\subsection{Introduction}\label{introduction}}

Videos are a crucial way people learn and pervasive in online education
platforms. Creating videos of a speaker with slides take time, energy,
and usually video editing skills. A large issue with such videos is that
updating the materials either requires remaking the entire video or
extensive editing and splicing of new segments. We present
\CRANpkg{ari}, the automated R instructor to mitigate these issues by
creating reproducible presentations and videos that can be automatically
generated. By using \pkg{ari}, we provide a tools for users to rapidly
create and update video content.

The premise of the \pkg{ari} package is that you have visual content
(e.g.~slides, figures) and you want to explain them with words (i.e.~a
script) in a video. Voice synthesizer services are available from
\href{https://cloud.google.com/text-to-speech/}{Google},
\href{https://azure.microsoft.com/en-us/services/cognitive-services/text-to-speech/}{Microsoft},
and \href{https://aws.amazon.com/polly/}{Amazon}. Many of these
synthesizers take make use of deep learning methods, such as WaveNet
(Van Den Oord et al. 2016) and have interfaces in R (Edmondson 2019;
Muschelli 2019a; Leeper 2017). Currently in \pkg{ari}, synthesis of the
the audio can be rendered using any of these services through the
\CRANpkg{text2speech} (Muschelli 2019b). The default is
\href{https://aws.amazon.com/polly/}{Amazon Polly}, which has text to
speech voice generation in over 21 languages, including a total of 29
dialects, implemented in the \CRANpkg{aws.polly} package (Leeper 2017).
In addition to multiple languages, the speech generation services
provide voices of different genders within the same language. We present
the \pkg{ari} package with reproducible use case examples and the video
outputs with different voices in multiple languages.

The \pkg{ari} package relies on the \CRANpkg{tuneR} package for reading
and manipulating audio output to combine split audio files and to add
pauses to audio files between slides (Ligges et al. 2018). Once the
audio is generated, it much be spliced with the images to make the
video. Multiple open source tools for video editing and splicing exist.
The \texttt{ffmpeg} (\url{http://www.ffmpeg.org/}) software is highly
powerful, has been thoroughly tested, and has been developed for almost
20 years; \pkg{ari} uses \texttt{ffmpeg} to overlay the images over the
audio. The output videos have been tested on multiple platforms,
including the YouTube and Coursera players. A default specification is
used in \pkg{ari}, such as bitrate, audio and video codecs used, and
output video format. The numerous additional video specifications can be
applied to command-line arguments \texttt{ffmpeg} through \pkg{ari}.

With these tools together, we can generate automated videos; we have
used \pkg{ari} for educational videos. The spoken scripts for these
videos can be stored in plain text, and therefore be version controlled,
edited, and updated easily. If the figures are created in a reproducible
framework, such as generated using R code, the entire video can be
reproducibly created and automatically updated. Thus, \pkg{ari} is the
Automated R Instructor. We will provide examples of creating videos
based on a slide deck in RMarkdown, a set of images and a script, and
discuss how to create slides using a Google Slide deck or PowerPoint
presentation.

\hypertarget{making-videos-with-ari}{%
\subsection{\texorpdfstring{Making videos with
\texttt{ari}}{Making videos with ari}}\label{making-videos-with-ari}}

The main workhorse of \pkg{ari} is the \texttt{ari\_stitch} function.
This function requires the audio to overlay on some images to have
already been generated. The \texttt{ari\_stitch} function takes the
audio and images, and ``stitches'' them together using \texttt{ffmpeg}.
In order to use \pkg{ari}, one must have an \texttt{ffmpeg} installation
to combine the audio and images. In the example below, 2 images
(packaged with \pkg{ari}) are overlaid withe white noise for
demonstration. This example also allows users to check if the output of
\texttt{ffmpeg} works with a desired video player.

\begin{Schunk}
\begin{Sinput}
library(tuneR)
library(ari)
result = ari_stitch(
  ari_example(c("mab1.png", "mab2.png")),
  list(noise(), noise()),
  output = "noise.mp4")
isTRUE(result)
\end{Sinput}
\begin{Soutput}
[1] TRUE
\end{Soutput}
\begin{Sinput}
attributes(result)$outfile
\end{Sinput}
\begin{Soutput}
[1] "/Users/johnmuschelli/Dropbox/Papers/ari_paper/noise.mp4"
\end{Soutput}
\end{Schunk}

The output is a logical indicator of success and the path of the output
file. The video for this output can be seen at
\url{https://youtu.be/3kgaYf-EV90}.

\hypertarget{synthesizer-authentication}{%
\subsection{Synthesizer
authentication}\label{synthesizer-authentication}}

In most cases, however, we do not have audio to overlay on images, but
must generate it. Though one can generate the spoken audio in many ways,
such as fitting a custom deep learning model, we will use the
aforementioned services (e.g.~Google) as they have direct APIs for use.
The downside of using such services is that users must go through steps
to provide authentication, whereas most of these APIs and the associated
R packages do not allow for interactive authentication such as OAuth.

The \pkg{text2speech} package provides a unified interface to these 3
services, and we will focus on Amazon Polly and its authentication
requirements. Polly is authenticated using the \CRANpkg{aws.signature}
package (Leeper 2019). The \pkg{aws.signature} documentation provides
options and steps to create the relevant credentials; we have also
provided an additional
\href{http://seankross.com/2017/05/02/Access-Amazon-Web-Services-in-R.html}{tutorial}.
Essentially, the user must sign up for the service and retrieve public
and private API keys and put them into their R profile or other areas
accesssible to R. Running
\texttt{text2speech::tts\_auth(service\ =\ "amazon")} will indicate if
authentication was successful (if using a different service, change the
\texttt{service} argument). NB: The APIs are generally paid services,
but many have free tiers or limits, such as Amazon Polly's free tier for
the first year (\url{https://aws.amazon.com/polly/pricing/}).

\hypertarget{making-videos-with-ari-1}{%
\subsection{\texorpdfstring{Making videos with
\texttt{ari}}{Making videos with ari}}\label{making-videos-with-ari-1}}

After Polly has been authenticated, videos can be using the
\texttt{ari\_spin} function with a set of images and of text. This text
is the ``script'' that is spoken over the images to create the output
video. The number of elements in the text need to be equal to the number
of images. Let us take a part of Mercutio's speech from Shakespeare's
Romeo and Juliet (Shakespeare 2003) and overlay it on 2 images from the
Wikipedia page about Mercutio
(\url{https://en.wikipedia.org/wiki/Mercutio}):

\begin{Schunk}
\begin{Sinput}
speech =  c(
  "I will now perform part of Mercutio's speech from Shakespeare's Romeo and Juliet.", 
  "O, then, I see Queen Mab hath been with you.
   She is the fairies' midwife, and she comes
   In shape no bigger than an agate-stone
   On the fore-finger of an alderman,
   Drawn with a team of little atomies
   Athwart men's noses as they lies asleep;")
mercutio_file = "death_of_mercutio.png"
mercutio_file2 = "mercutio_actor.png"
\end{Sinput}
\end{Schunk}

\begin{Schunk}
\begin{Sinput}
shakespeare_result = ari_spin(
  c(mercutio_file, mercutio_file2),
  speech, output = "romeo.mp4", voice = "Joanna")
isTRUE(shakespeare_result)
\end{Sinput}
\end{Schunk}

The speech output can be seen at \url{https://youtu.be/SFhvM9gI0kE} . We
chose the voice ``Joanna'' to the the female US-English speaker for the
script. The voices are language-dependent; we can see the available
voices for English for Amazon Polly below (from
\url{https://docs.aws.amazon.com/polly/latest/dg/SupportedLanguage.html}):

\begin{Schunk}

\begin{tabular}{l|l|l|l|l}
\hline
voice & language & language\_code & gender & service\\
\hline
Russell & Australian English & en-AU & Male & amazon\\
\hline
Nicole & Australian English & en-AU & Female & amazon\\
\hline
Amy & British English & en-GB & Female & amazon\\
\hline
Brian & British English & en-GB & Male & amazon\\
\hline
Emma & British English & en-GB & Female & amazon\\
\hline
Raveena & Indian English & en-IN & Female & amazon\\
\hline
Aditi & Indian English & en-IN & Female & amazon\\
\hline
Salli & US English & en-US & Female & amazon\\
\hline
Joanna & US English & en-US & Female & amazon\\
\hline
Matthew & US English & en-US & Male & amazon\\
\hline
Ivy & US English & en-US & Female & amazon\\
\hline
Justin & US English & en-US & Male & amazon\\
\hline
Kendra & US English & en-US & Female & amazon\\
\hline
Kimberly & US English & en-US & Female & amazon\\
\hline
Joey & US English & en-US & Male & amazon\\
\hline
Geraint & Welsh English & en-GB-WLS & Male & amazon\\
\hline
\end{tabular}

\end{Schunk}

Though the voice generation is relatively clear, we would not classify
the speech as passionate or with a high level of emphasis. Thus, be
believe these videos may be best used for conveying information or
education as opposed to entertainment. We can also generate the video
using the voice \texttt{Brian}, which is an British English male voice:

\begin{Schunk}
\begin{Sinput}
gb_result = ari_spin(
  c(mercutio_file, mercutio_file2),
  speech, output = "romeo_gb.mp4", voice = "Brian")
isTRUE(gb_result)
\end{Sinput}
\end{Schunk}

The speech output can be seen at \url{https://youtu.be/fSS0JSb4VxM}. The
output video format is MP4 by default, but can be any format (aka
``muxers'') that the \texttt{ffmpeg} installation support, see the
function \texttt{ffmpeg\_muxers}. Supported codecs can be founded using
the functions \texttt{ffmpeg\_audio\_codecs} and
\texttt{ffmpeg\_video\_codecs}. The images and script can be presented
in a number of ways, such as a text file and a series of PNG images.
More likely, the images and script will be bundled together, such as a
Google Slide deck/PowerPoint presentation with the script in the notes
section, or an HTML slide presentation based in RMarkdown, where the
script is in the HTML comments.

For most R users, we believe the most natural setting is that the user
has a slide deck using RMarkdown, for example using the
\CRANpkg{rmarkdown} or \CRANpkg{xaringan} packages (Allaire et al. 2019;
Xie, Allaire, and Grolemund 2018; Xie 2018). In \pkg{ari}, the HTML
slides are rendered using \CRANpkg{webshot} (Chang 2018) and the script
is located in HTML comments (i.e.~between \texttt{\textless{}!-\/-} and
\texttt{-\/-\textgreater{}}). For example, in the
\texttt{ari\_comments.Rmd}, which is a \texttt{ioslides} type of
markdown slide deck, we have the last slide:

\begin{Schunk}
\begin{Sinput}
x = readLines(ari_example("ari_comments.Rmd"))
tail(x[ x != ""], 4)
\end{Sinput}
\begin{Soutput}
[1] "## Conclusion"                                             
[2] "<!--"                                                      
[3] "Thank you for watching this video and good luck using Ari!"
[4] "-->"                                                       
\end{Soutput}
\end{Schunk}

so that the script for this slide starts with \texttt{"Thank\ you"}.
This setup allows for one plain text, version-controllable, integrated
document that can reproducibly generate a video. We believe these
features allow creators to make agile vidoes, that can easily be updated
with new material or changed when errors or typos are found.

Users can pass in both the RMarkdown document and the resulting output,
or simply the document, and the output will be created using
\texttt{render} from \pkg{rmarkdown} (Allaire et al. 2019). Here we
create the video for \texttt{ari\_comments.Rmd}:

\begin{Schunk}
\begin{Sinput}
# Create a video from an R Markdown file with comments and slides
res = ari_narrate(
  script = ari_example("ari_comments.Rmd"),
  voice = "Kendra",
  capture_method = "iterative")
\end{Sinput}
\end{Schunk}

The output video is located at \url{https://youtu.be/rv9fg_qsqc0}. Some
HTML slides take a bit to render on \pkg{webshot}; for example may be
rendered dark gray instead of white. If you change the \texttt{delay}
argument in \texttt{ari\_narrate}, passed to \pkg{webshot}, this can
resolve some issues by allowing the page to fully render, but may take a
bit longer to run. Also, the argument \texttt{capture\_method} allows
for the control on how \texttt{webshot} is run. Using the value
\texttt{vectorized}, \pkg{webshot} is run on the entire slide deck and
is faster, but may have some issues. The value \texttt{iterative} runs
\texttt{webshot} for each slide separately, which can be more robust,
but can be slower.

With respect to accessibility, as \pkg{ari} has the synthesized script,
this provides for direct subtitles for those hard of hearing rather than
relying on other services, such as YouTube, to provide a speech to text
translation. When using \texttt{ari\_spin}, if the \texttt{subtitles}
flag is marked true, then an SRT file will be output with the video.

One issue with synthesis of technical information is that changes to the
script are required for Amazon Polly or other services to provide a
correct pronunciation. For example, if you want the service to say
``RStudio'' or ``ggplot2'', the script should say ``R Studio'' and ``g g
plot 2''. Thus, you may want to make edits to the subtitle file before
uploading.

In order to create a video from a Google Slide deck or PowerPoint
presentation, the slides should be converted to a set of images, likely
PNGs. In order to get the script for the video, we suggest putting the
script for each slide in the notes section of that slide. We have built
some of this additional functionality for video generation in our
package \pkg{didactr} (\url{https://github.com/muschellij2/didactr}).
The notes of slides can be extracted using \CRANpkg{rgoogleslides}
(Noorazman 2018) for Google Slides via the API or using
\CRANpkg{readOffice}/\CRANpkg{officer} (Gohel 2019; Ewing 2017) to read
from PowerPoint documents. Google Slides can be downloaded as PDF and
converted to PNGs using the \CRANpkg{pdftools} package (Ooms 2019). The
\pkg{didactr} package also has a \texttt{pptx\_notes} function for
reading PowerPoint notes and wraps most of the functionality for
conversion. Converting from PowerPoint to PDF can be done using
LibreOffice, which \CRANpkg{docxtractr} (Rudis and Muir, n.d.) has
wrapper functions to achieve this.

To demonstrate this, we use an example PowerPoint is located on Figshare
(\url{https://figshare.com/articles/Example_PowerPoint_for_ari/8865230}).
We can convert the PowerPoint to PDF, then to a set of PNG images, then
extract the notes.

\begin{Schunk}
\begin{Sinput}
pptx = "ari.pptx"
pdf = docxtractr::convert_to_pdf(pptx)
pngs = pdftools::pdf_convert(pdf, dpi = 300)
notes = didactr::pptx_notes(pptx)
notes
\end{Sinput}
\end{Schunk}

\begin{Schunk}
\begin{Soutput}
[1] "Sometimes it’s hard for an instructor to take the time to record their lectures.
For example, I’m in a coffee shop and it may be loud."

[2] "Here is an example of a plot with really small axes.  We plot the x versus the y
-variables and a smoother between them."
\end{Soutput}
\end{Schunk}

We can then render the video with the Kimberly voice. We use the
\texttt{divisible\_height} argument to ensure the height of the images
are divisible by 2, as the \texttt{x264} codec we are using requires
this:

\begin{Schunk}
\begin{Sinput}
pptx_result = ari_spin(pngs, notes, output = "pptx.mp4", voice = "Kimberly",
    divisible_height = TRUE, subtitles = TRUE)
isTRUE(pptx_result)
\end{Sinput}
\end{Schunk}

You can see the output at \url{https://youtu.be/TBb3Am6xsQw}. Here we
can see the first few lines of the subtitle file:

\begin{Schunk}
\begin{Soutput}
[1] "1"                                       
[2] "00:00:00,000 --> 00:00:02,025"           
[3] "Sometimes it’s hard for an instructor to"
[4] "2"                                       
[5] "00:00:02,025 --> 00:00:04,005"           
[6] "take the time to record their lectures." 
\end{Soutput}
\end{Schunk}

For Google Slides, the slide deck can be downloaded as a PowerPoint and
the previous steps can be used; it can also be downloaded directly as a
PDF. The \pkg{didactr} package has the function
\texttt{gs\_notes\_from\_slide} to extract the notes for synthesis. As
this extraction process requires authentication, we will omit it here.
Thus, we should be able to create videos using RMarkdown, Google Slides,
or PowerPoint presentations in an automatic fashion.

\hypertarget{future-directions}{%
\subsection{Future directions}\label{future-directions}}

We believe the heavy reliance on an \texttt{ffmpeg} installation can be
mitigated in the future with advances in the \pkg{av} package. Though
the \pkg{av} package has powerful functionality and is currently porting
more from \texttt{libav} and therefore \texttt{ffmpeg}, it currently
does not have the capabilities required for \pkg{ari}. Although third
party installation from \url{https://ffmpeg.org/} can be burdensome to a
user, package managers such as \texttt{brew} for OSX and \texttt{choco}
for Windows provide installations.

Although we rely on Amazon Polly for voice synthesis, other packages
provide voice synthesis, such as \CRANpkg{mscstts} for Microsoft and
\CRANpkg{googleLanguageR} for Google. We aim to harmonize these
synthesis options, so that users can choose to create videos with the
services that they support or have access to.

Scripts can be automatically translated into other languages with
services like the \href{https://cloud.google.com/translate/docs/}{Google
Translation API}, which \pkg{googleLanguageR} provides an interface.
Amazon Polly can speak languages other than English. This means you can
write a lecture once and generate slides and videos in multiple
languages.

We have created a Docker environment
(\url{https://github.com/seankross/bologna}) with the requirements to
create videos using \pkg{ari}. This Docker image increases the level of
reproducibility and can be used to create standalone disk images to
create content.

\hypertarget{conclusions}{%
\subsection{Conclusions}\label{conclusions}}

The \pkg{ari} package combines multiple open-source tools and APIs to
create reproducible workflows for creating videos. These videos can be
created using RMarkdown documents, PowerPoint presentations, Google
Slide decks, or simply series of images. The audio overlaid on the
images can be separate or contained within the storage of the images.
These workflows can then be reproduced in the future and easily updated.
As the current voice synthesis options are somewhat limited in the
tenacity and inflection given, we believe that educational and
informational videos are the most applicable area.

\bibliography{RJreferences}

\hypertarget{refs}{}
\leavevmode\hypertarget{ref-rmarkdown}{}%
Allaire, JJ, Yihui Xie, Jonathan McPherson, Javier Luraschi, Kevin
Ushey, Aron Atkins, Hadley Wickham, Joe Cheng, Winston Chang, and
Richard Iannone. 2019. \emph{rmarkdown: Dynamic Documents for R}.
\url{https://rmarkdown.rstudio.com}.

\leavevmode\hypertarget{ref-webshot}{}%
Chang, Winston. 2018. \emph{webshot: Take Screenshots of Web Pages}.
\url{https://CRAN.R-project.org/package=webshot}.

\leavevmode\hypertarget{ref-googleLanguageR}{}%
Edmondson, Mark. 2019. \emph{googleLanguageR: Call Google's 'Natural
Language' API, 'Cloud Translation' API, 'Cloud Speech' API and 'Cloud
Text-to-Speech' API}.

\leavevmode\hypertarget{ref-readOffice}{}%
Ewing, Mark. 2017. \emph{readOffice: Read Text Out of Modern Office
Files}. \url{https://CRAN.R-project.org/package=readOffice}.

\leavevmode\hypertarget{ref-officer}{}%
Gohel, David. 2019. \emph{officer: Manipulation of Microsoft Word and
PowerPoint Documents}. \url{https://CRAN.R-project.org/package=officer}.

\leavevmode\hypertarget{ref-aws.polly}{}%
Leeper, Thomas J. 2017. \emph{aws.polly: Client for AWS Polly}.

\leavevmode\hypertarget{ref-aws.signature}{}%
---------. 2019. \emph{aws.signature: Amazon Web Services Request
Signatures}.

\leavevmode\hypertarget{ref-tuneR}{}%
Ligges, Uwe, Sebastian Krey, Olaf Mersmann, and Sarah Schnackenberg.
2018. \emph{tuneR: Analysis of Music and Speech}.
\url{https://CRAN.R-project.org/package=tuneR}.

\leavevmode\hypertarget{ref-mscstts}{}%
Muschelli, John. 2019a. \emph{mscstts: R Client for the Microsoft
Cognitive Services 'Text-to-Speech' REST API}.
\url{https://CRAN.R-project.org/package=mscstts}.

\leavevmode\hypertarget{ref-text2speech}{}%
---------. 2019b. \emph{text2speech: Text to Speech}.
\url{https://github.com/muschellij2/text2speech}.

\leavevmode\hypertarget{ref-rgoogleslides}{}%
Noorazman, Hairizuan Bin. 2018. \emph{rgoogleslides: R Interface to
Google Slides}. \url{https://CRAN.R-project.org/package=rgoogleslides}.

\leavevmode\hypertarget{ref-pdftools}{}%
Ooms, Jeroen. 2019. \emph{pdftools: Text Extraction, Rendering and
Converting of PDF Documents}.
\url{https://CRAN.R-project.org/package=pdftools}.

\leavevmode\hypertarget{ref-docxtractr}{}%
Rudis, Bob, and Chris Muir. n.d. \emph{docxtractr: Extract Data Tables
and Comments from Microsoft Word Documents}.
\url{http://gitlab.com/hrbrmstr/docxtractr}.

\leavevmode\hypertarget{ref-shakespeare2003romeo}{}%
Shakespeare, William. 2003. \emph{Romeo and Juliet}. Cambridge
University Press.

\leavevmode\hypertarget{ref-van2016wavenet}{}%
Van Den Oord, Aäron, Sander Dieleman, Heiga Zen, Karen Simonyan, Oriol
Vinyals, Alex Graves, Nal Kalchbrenner, Andrew W Senior, and Koray
Kavukcuoglu. 2016. ``WaveNet: A Generative Model for Raw Audio.''
\emph{SSW} 125.

\leavevmode\hypertarget{ref-xaringan}{}%
Xie, Yihui. 2018. \emph{xaringan: Presentation Ninja}.
\url{https://CRAN.R-project.org/package=xaringan}.

\leavevmode\hypertarget{ref-rmarkdownbook}{}%
Xie, Yihui, J.J. Allaire, and Garrett Grolemund. 2018. \emph{R Markdown:
The Definitive Guide}. Boca Raton, Florida: Chapman; Hall/CRC.
\url{https://bookdown.org/yihui/rmarkdown}.

\bibliography{RJreferences.bib}

\address{%
Sean Kross\\
Cognitive Science, University of California, San Diego\\
9500 Gilman Dr.\\ La Jolla, CA 92093\\
}
\href{mailto:author1@work}{\nolinkurl{author1@work}}

\address{%
John Muschelli\\
Department of Biostatistics, Johns Hopkins Bloomberg School of Public
Health\\
615 N Wolfe Street\\ Baltimore, MD 21231\\
}
\href{mailto:jmusche1@jhu.edu}{\nolinkurl{jmusche1@jhu.edu}}

\address{%
Jeffrey T. Leek\\
Department of Biostatistics, Johns Hopkins Bloomberg School of Public
Health\\
615 N Wolfe Street\\ Baltimore, MD 21231\\
}
\href{mailto:jtleek@jhu.edu}{\nolinkurl{jtleek@jhu.edu}}

